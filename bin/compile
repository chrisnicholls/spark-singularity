#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# Fail immediately on non-zero exit code.
set -e
# Fail immediately on non-zero exit code within a pipeline.
set -o pipefail
# Fail on undeclared variables.
set -u
# Debug, echo every command
#set -x

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
BP_DIR=`cd $(dirname $0); cd ..; pwd`

echo "=====> Overlaying Spark Singularity config on Spark in Space"
mv $BP_DIR/Procfile* $BUILD_DIR/

mkdir -p $BUILD_DIR/.profile.d
mv $BP_DIR/.profile.d/* $BUILD_DIR/.profile.d/

mkdir -p $BUILD_DIR/conf
mv $BP_DIR/conf/* $BUILD_DIR/conf/

# Overlay the special space-proxy/ prefix
mkdir -p $BUILD_DIR/space-proxy/conf/
mv $BUILD_DIR/conf/nginx.conf.erb $BUILD_DIR/space-proxy/conf/

mkdir -p $BUILD_DIR/bin
mv $BP_DIR/bin/master-url $BUILD_DIR/bin/
mv $BP_DIR/bin/spark-master $BUILD_DIR/bin/
mv $BP_DIR/bin/spark-worker $BUILD_DIR/bin/
